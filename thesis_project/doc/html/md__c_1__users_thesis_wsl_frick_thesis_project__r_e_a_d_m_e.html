<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Current Monitor API: Current Measurement Library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Current Monitor API
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Documentation for current monitoring with PAC1720 sensors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__c_1__users_thesis_wsl_frick_thesis_project__r_e_a_d_m_e.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Current Measurement Library </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Current Measurement Library provides an API for configuration and query of the PAC1720 current sensors. Multiple sensors can be controlled by means of the library. It is designed to be portable an can be adapted to an individual application by the adapter module.</p>
<h2>Introduction</h2>
<p>The driver module of the library contains its core functionality such as calculation of the sensor values. The adapter serves as wrapper for the driver and can be changed to the user's need in order to fit the library to an application. A generic communication interface is provided by the adapter module that allows the driver to communicate with the sensors by a serial bus such as the TWI. Therefore an implementation of the bus communication interface is to be provided by the programmer to the adapter. After initialization of the adapter module the measurements can be triggered and the results read from the driver's interface.</p>
<h2>Dependencies</h2>
<p>Dependencies of the Current Measurement API used at its development:</p>
<ul>
<li>bazel 0.24.0</li>
<li>EmbeddedSystemsBuildScripts 0.4.6</li>
<li>i2cmaster library</li>
<li>LUFA</li>
</ul>
<p><a href="http://artifactory.es.uni-due.de:8081/artifactory/libs-release-local/FKS/embedded-systems-build-scripts/0.4.6/embedded-systems-build-scripts.tar.gz">Source Repo for some dependencies</a></p>
<h2>Documentation</h2>
<h3>Code Documentation</h3>
<p>The code is documented using Doxygen. See relevant files in folder doc.</p>
<h2>Required configuration</h2>
<p>A <code>WORKSPACE</code> file in the project folder is required to setup the bazel toolchain. Follow the manual on <code><a href="https://github.com/es-ude/EmbeddedSystemsBuildScripts">https://github.com/es-ude/EmbeddedSystemsBuildScripts</a></code>. In the <code>BUILD</code> file add your application source file to a default embedded build rule and add a <code>cc_library</code> containing the Current Measurement Library to the dependencies. When building the project the dependencies are automatically managed.</p>
<h2>How to flash</h2>
<p>The flashing was done with the 'avr dude' program. Therefore the CDC bootloader of the LUFA project was flashed onto the MCU. The bootloader uses the AVR109 programmer. To flash the application onto the MCU excute the command <code>sudo avrdude -c AVR109 -p &lt;mcu&gt; -P &lt;port&gt; -U flash:w:&lt;file&gt;.hex</code> in the console.</p>
<h2>How to use the API</h2>
<h3>Including it</h3>
<p>Include the header file of the adapter into your project at the desired location and modify the include of the driver header according to the location.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="adapter___p_a_c1720_8h.html">adapter_PAC1720.h</a>&gt;</span></div></div><!-- fragment --><h2>Driver</h2>
<p>The entry point of the driver API is the function <code>adapter_init_PAC1720_user_defined</code>. It requires a pointer to an instance of the device <code>struct <a class="el" href="struct_p_a_c1720__device.html">PAC1720_device</a></code> where the configuration of the sensor is stored. The sensor is initialized by the function call and the measurements can be triggered by a call to the function <code>get_all_measurements_PAC1720</code>. Afterwards the measurements can be read from the device struct.</p>
<h2>Adapter</h2>
<p>The adapter needs to be initialized before the use of its functionality. Provide an instance of the <code>struct <a class="el" href="struct_f_i_e_l_d___b_u_s___i_n_t_e_r_f_a_c_e.html" title="Struct that is used to define bus communication interface.">FIELD_BUS_INTERFACE</a></code> to the function <code>adapter_init_peripherals</code>. This initializes the required communication interface of the adapter. The instance of the struct must be supplied by references to an implementation of bus communication. Basically the adapter wraps the driver API and provides an interface to it. The function <code>adapter_init_PAC1720_user_defined</code> is to be called with an <code>struct <a class="el" href="struct_p_a_c1720__device.html">PAC1720_device</a></code> instance as described above. Internally the function <code>adapter_init_PAC1720_user_defined</code>is called. The measurements can be triggered by the function <code>adapter_get_measurements_PAC1720</code> and the reading of the results is the same as described above.</p>
<h2>Initialization process</h2>
<p>Instanciate a <code>struct <a class="el" href="struct_f_i_e_l_d___b_u_s___i_n_t_e_r_f_a_c_e.html" title="Struct that is used to define bus communication interface.">FIELD_BUS_INTERFACE</a></code> and assign the addresses of the bus communication functions to the struct members. </p><div class="fragment"><div class="line"><span class="comment">/* Instantiate a bus interface */</span></div><div class="line"><span class="keyword">struct </span><a class="code" href="struct_f_i_e_l_d___b_u_s___i_n_t_e_r_f_a_c_e.html">FIELD_BUS_INTERFACE</a> external_bus_interface = {</div><div class="line">    .init       = &amp;<a class="code" href="group__pfleury__ic2master.html#ga5730d9445429351b9f750084c5cb5aae">i2c_init</a>,</div><div class="line">    .stop       = &amp;<a class="code" href="group__pfleury__ic2master.html#gad35d4e4f52ca74b503d5e5e1e0a3f5f3">i2c_stop</a>,</div><div class="line">    .start      = &amp;<a class="code" href="group__pfleury__ic2master.html#ga58dfadce0c2fee4bfac01df6cd2b4477">i2c_start</a>,</div><div class="line">    .repStart   = &amp;<a class="code" href="group__pfleury__ic2master.html#ga93a9461da34295250ba935bbce9a980d">i2c_rep_start</a>,</div><div class="line">    .startWait  = &amp;<a class="code" href="group__pfleury__ic2master.html#gaee3747a01738315cd5580588994b6c28">i2c_start_wait</a>,</div><div class="line">    .write      = &amp;<a class="code" href="group__pfleury__ic2master.html#gadd947aade44ed6b7f92265f9dec4a711">i2c_write</a>,</div><div class="line">    .readAck    = &amp;<a class="code" href="group__pfleury__ic2master.html#ga32ac22052d55f93375b024192217db21">i2c_readAck</a>,</div><div class="line">    .readNak    = &amp;<a class="code" href="group__pfleury__ic2master.html#gad89e839fc17b05fbb5dd79897c55234e">i2c_readNak</a></div><div class="line">};</div></div><!-- fragment --><p>Assign a reference to an implementation of a delay function to an instance of the relevant function pointer type. </p><div class="fragment"><div class="line"></div><div class="line"><a class="code" href="group__adapter.html#ga87111bfd5f50b4aa1cf9d61f86d4dde6">delay_function_ptr</a> external_delay_function = &amp;<a class="code" href="user__delay_8h.html#adc86d5995b888a6f4ef7dd5647b94f8f">user_delay_ms</a>;</div></div><!-- fragment --><p>Call the init function of the adapter. </p><div class="fragment"><div class="line"><a class="code" href="group__adapter.html#gacc8e6007494e0763460aa21b3fc6f64e">adapter_init_peripherals</a>(&amp;external_bus_interface, external_delay_function);</div></div><!-- fragment --><p>Instanciate a <code>struct <a class="el" href="struct_p_a_c1720__device.html">PAC1720_device</a></code> and set the desired configuration. The names are optional but the resistor values of the measurement resistors is mandatory. The sensor's bus address as well. All other settings are optional but some of them should be set to default as shown below.</p>
<div class="fragment"><div class="line"><span class="comment">// Minimum settings required for an initialization:</span></div><div class="line"><span class="keyword">struct </span><a class="code" href="struct_p_a_c1720__device.html">PAC1720_device</a> dev = </div><div class="line">{</div><div class="line">    .<a class="code" href="group__driver.html#ga381d1f2a3a83bef34d75f1fc11ce5985">DEV_sensor_address</a>                                     = 0x4F,</div><div class="line">    .DEV_conversion_rate_reg                                = CONVERSION_DEFAULT,</div><div class="line">    .DEV_CH1_conf.CH_current_sense_resistor_value           = 0.8f,</div><div class="line">    .DEV_CH1_conf.CH_current_sense_sampling_time_reg        = CURRENT_SAMPLE_TIME_DEFAULT,</div><div class="line">    .DEV_CH1_conf.CH_current_sense_FSR_reg                  = CURRENT_SENSE_RANGE_DEFAULT,</div><div class="line">    .DEV_CH1_conf.CH_source_voltage_sampling_time_reg       = VSRC_SAMPLE_TIME_DEFAULT,</div><div class="line"></div><div class="line">    .DEV_CH2_conf.CH_current_sense_resistor_value           = 0.8f,</div><div class="line">    .DEV_CH2_conf.CH_current_sense_sampling_time_reg        = CURRENT_SAMPLE_TIME_DEFAULT,</div><div class="line">    .DEV_CH2_conf.CH_current_sense_FSR_reg                  = CURRENT_SENSE_RANGE_DEFAULT,</div><div class="line">    .DEV_CH2_conf.CH_source_voltage_sampling_time_reg       = VSRC_SAMPLE_TIME_DEFAULT,</div><div class="line">}; </div></div><!-- fragment --><p>After creating an instance call the init function with a reference to the struct. </p><div class="fragment"><div class="line"><a class="code" href="group__adapter.html#ga94cd612009aa306b2e085a77252b6c35">adapter_init_PAC1720_from_field</a>(&amp;dev);</div></div><!-- fragment --><h2>Measurements</h2>
<p>Now the measurements can be triggered by the relevant function call anproviding a the struct instance reference. </p><div class="fragment"><div class="line"><a class="code" href="group__adapter.html#ga56f4b43af759ce48e135da6cd6d8885a">adapter_get_measurements_PAC1720</a>(&amp;dev);</div></div><!-- fragment --><p>The results can be read from the measurement struct in the device instance. </p><div class="fragment"><div class="line"><span class="keywordtype">char</span> *name = dev-&gt;<a class="code" href="group__driver.html#gaca1e9392455d02e76179264e5738a129">DEV_CH1_conf</a>.<a class="code" href="group__driver.html#gaf9be1b36f9b47706f73428c89d36bd42">CH_name_opt</a>, </div><div class="line"><span class="keywordtype">float</span> current = dev-&gt;<a class="code" href="group__driver.html#gada1a661d41e52cb0ec773f05a1e0fb82">DEV_CH1_measurements</a>.CURRENT, </div><div class="line"><span class="keywordtype">float</span> voltage = dev-&gt;<a class="code" href="group__driver.html#gada1a661d41e52cb0ec773f05a1e0fb82">DEV_CH1_measurements</a>.SOURCE_VOLTAGE, </div><div class="line"><span class="keywordtype">float</span> power = dev-&gt;<a class="code" href="group__driver.html#gada1a661d41e52cb0ec773f05a1e0fb82">DEV_CH1_measurements</a>.POWER,</div></div><!-- fragment --><h2>Deconstruction</h2>
<p>The struct instance is to be deconstructed when not longer required. </p><div class="fragment"><div class="line"><a class="code" href="group__adapter.html#ga32b7b3731128d51f23e7af678c31b858">adapter_destroy_PAC1720</a>(&amp;dev); </div></div><!-- fragment --><h2>Running Unit tests</h2>
<p>The tests can be run automatically by bazel. Therefore execute the command <code>bazel test test:all</code> in the console.</p>
<h1>Contact</h1>
<p><a href="#" onclick="location.href='mai'+'lto:'+'nic'+'ol'+'as.'+'fr'+'ick'+'@s'+'tud'+'.u'+'ni-'+'du'+'e.d'+'e'; return false;">nicol<span style="display: none;">.nosp@m.</span>as.f<span style="display: none;">.nosp@m.</span>rick@<span style="display: none;">.nosp@m.</span>stud<span style="display: none;">.nosp@m.</span>.uni-<span style="display: none;">.nosp@m.</span>due.<span style="display: none;">.nosp@m.</span>de</a> </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>
